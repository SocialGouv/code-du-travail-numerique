{"version":3,"sources":["../../src/tests/fetch_mock_data.js"],"sourcesContent":["import { Client } from \"@elastic/elasticsearch\";\nimport { DOCUMENTS } from \"@socialgouv/cdtn-elasticsearch\";\nimport { getSourceByRoute, SOURCES } from \"@socialgouv/cdtn-sources\";\nimport { writeFile as _writeFile } from \"fs\";\nimport { join } from \"path\";\nimport { promisify } from \"util\";\n\nimport { CDTN_ADMIN_VERSION } from \"../routes/v1.prefix\";\nimport versions from \"./versions.json\";\n\nconst writeFile = promisify(_writeFile);\n\nconst ELASTICSEARCH_URL =\n  process.env.ELASTICSEARCH_URL || \"http://localhost:9200\";\n\nconst client = new Client({\n  log: [{ levels: [\"error\", \"warning\"], type: \"stdio\" }],\n  node: `${ELASTICSEARCH_URL}`,\n});\n\nconst getDataFromUrl = (url) => {\n  const [, sourceRoute, slug] = url.split(\"/\");\n  let source = getSourceByRoute(sourceRoute);\n  // since theme routing has changed, we will keep this monkey patch for a while\n  let trimmedSlug = slug;\n  if (source === SOURCES.THEMES) {\n    trimmedSlug = slug.replace(/^\\d*-/, \"\");\n  }\n  // Beware, \"/fiche-ministere-travail/la-demission\" matches both\n  // the split introduction and the full page. We always refer to the full page\n  // to avoid bugs (because this page could have no introduction).\n  if (source === SOURCES.SHEET_MT && !slug.includes(\"#\")) {\n    source = SOURCES.SHEET_MT_PAGE;\n  }\n  return {\n    slug: trimmedSlug,\n    source,\n  };\n};\n\nconst getDocumentByUrlQuery = (\n  url,\n  _source = [\n    \"title\",\n    \"source\",\n    \"slug\",\n    \"description\",\n    \"url\",\n    \"action\",\n    \"breadcrumbs\",\n    \"cdtnId\",\n    \"isPublished\",\n    \"refs\",\n  ]\n) => {\n  const { slug, source } = getDataFromUrl(url);\n  if (!source) return;\n  return {\n    _source,\n    query: {\n      bool: {\n        filter: [{ term: { slug } }, { term: { source } }],\n      },\n    },\n    size: 1,\n  };\n};\n\n/*\n * Make sure you have at least two documents with the same slug here to test a corner case (certificat-de-travail)\n * Also make sure that you have a fiche-ministere-travail without a \"#\" to ensure that url resolution works fine\n */\nconst documentsSlugs = [\n  \"/themes/demission\",\n  \"/themes/depart-de-lentreprise\",\n  \"/themes/embauche-et-contrat-de-travail\",\n  \"/fiche-service-public/arret-maladie-pendant-le-preavis-quelles-consequences\",\n  \"/fiche-service-public/demission-dun-salarie\",\n  \"/fiche-service-public/demission-dune-assistante-maternelle\",\n  \"/fiche-service-public/certificat-de-travail\",\n  \"/fiche-ministere-travail/la-demission\",\n  \"/fiche-ministere-travail/la-demission#Comment-presenter-une-demission\",\n  \"/fiche-ministere-travail/la-demission#L-absence-prolongee-du-salarie-est-elle-une-demission\",\n  \"/code-du-travail/r1225-18\",\n  \"/code-du-travail/l1237-1\",\n  \"/outils/preavis-demission\",\n  \"/outils/indemnite-licenciement\",\n  \"/modeles-de-courriers/demande-de-rendez-vous-en-vue-dune-rupture-conventionnelle\",\n  \"/modeles-de-courriers/rupture-de-periode-dessai-a-linitiative-de-lemployeur\",\n  \"/modeles-de-courriers/certificat-de-travail\",\n  \"/convention-collective/1747-activites-industrielles-de-boulangerie-et-patisserie\",\n  \"/convention-collective/843-boulangerie-patisserie-entreprises-artisanales\",\n  \"/convention-collective/2701-banque-personnel-des-banques-de-la-guyane\",\n  \"/convention-collective/2120-banque\",\n  \"/external/mon-compte-formation\",\n  \"/external/index-egapro\",\n  \"/fiche-ministere-travail/5-questions-reponses-sur-la-sante-au-travail\",\n  \"/highlights/homepage\",\n  \"/prequalified/comment-demissionner\",\n  \"/outils/heures-recherche-emploi\",\n];\n\nconst ES_INDEX_PREFIX = process.env.ES_INDEX_PREFIX || \"cdtn_test\";\n\nasync function updateDocumentsData(slugs) {\n  const index = `${ES_INDEX_PREFIX}-${CDTN_ADMIN_VERSION}_${DOCUMENTS}`;\n  const requests = slugs.reduce((state, slug) => {\n    state.push({ index });\n    state.push(getDocumentByUrlQuery(slug, []));\n    return state;\n  }, []);\n  try {\n    const { body } = await client.msearch({ body: requests });\n    const data = [];\n    for (const res of body.responses) {\n      if (res.hits.hits.length === 1) {\n        const [item] = res.hits.hits;\n        data.push(item._source);\n      }\n    }\n    // it's easier to add a static glossary and versions entry\n    data.push(\n      {\n        data: [\n          {\n            abbreviations: [],\n            definition: \"<p>Mesure d'urgence prise par précaution.</p>\",\n            references: [\n              \"https://www.service-public.fr/particuliers/glossaire/R37450\",\n            ],\n            slug: \"a-titre-conservatoire\",\n            title: \"A titre conservatoire\",\n            variants: [],\n          },\n        ],\n        source: \"glossary\",\n      },\n      {\n        cdtnId: \"98b9c85542\",\n        contributions: true,\n        date_publi: \"1981-04-01T00:00:00.000Z\",\n        description:\n          \"Retrouvez les questions-réponses les plus fréquentes organisées par thème et élaborées par le ministère du Travail concernant cette convention collective.\",\n        excludeFromSearch: false,\n        id: \"KALICONT000005635191\",\n        isPublished: true,\n        longTitle:\n          \"Convention collective nationale du commerce et de la réparation de l'automobile, du cycle et du motocycle et des activités connexes, ainsi que du contrôle technique automobile du 15 janvier 1981. Etendue par arrêté du 30 octobre 1981 JONC 3 décembre 1981.\",\n        metaDescription:\n          \"Idcc 1090 : Services de l'automobile (Commerce et réparation de l'automobile, du cycle et du motocycle, activités connexes, contrôle technique automobile, formation des conducteurs)\",\n        num: 1090,\n        shortTitle:\n          \"Services de l'automobile (Commerce et réparation de l'automobile, du cycle et du motocycle, activités connexes, contrôle technique automobile, formation des conducteurs)\",\n        slug: \"1090-services-de-lautomobile-commerce-et-reparation-de-lautomobile-du-cycle\",\n        source: \"conventions_collectives\",\n        text: \"IDCC 1090: Convention collective nationale du commerce et de la réparation de l'automobile, du cycle et du motocycle et des activités connexes, ainsi que du contrôle technique automobile du 15 janvier 1981. Etendue par arrêté du 30 octobre 1981 JONC 3 décembre 1981. Services de l'automobile (Commerce et réparation de l'automobile, du cycle et du motocycle, activités connexes, contrôle technique automobile, formation des conducteurs)\",\n        title:\n          \"Services de l'automobile (Commerce et réparation de l'automobile, du cycle et du motocycle, activités connexes, contrôle technique automobile, formation des conducteurs)\",\n        url: \"https://www.legifrance.gouv.fr/affichIDCC.do?idConvention=KALICONT000005635191\",\n      },\n      versions\n    );\n    await writeFile(\n      join(__dirname, \"./cdtn_document.data.json\"),\n      JSON.stringify(data, 0, 2)\n    );\n  } catch (error) {\n    console.error(error.meta || error);\n  }\n}\n\nif (module === require.main) {\n  updateDocumentsData(documentsSlugs).catch((error) => {\n    console.error(\"›››\" + error);\n  });\n}\n"],"names":["Client","DOCUMENTS","getSourceByRoute","SOURCES","writeFile","_writeFile","join","promisify","CDTN_ADMIN_VERSION","versions","ELASTICSEARCH_URL","process","env","client","log","levels","type","node","getDataFromUrl","url","sourceRoute","slug","split","source","trimmedSlug","THEMES","replace","SHEET_MT","includes","SHEET_MT_PAGE","getDocumentByUrlQuery","_source","query","bool","filter","term","size","documentsSlugs","ES_INDEX_PREFIX","updateDocumentsData","slugs","index","requests","reduce","state","push","body","msearch","data","res","responses","hits","length","item","abbreviations","definition","references","title","variants","cdtnId","contributions","date_publi","description","excludeFromSearch","id","isPublished","longTitle","metaDescription","num","shortTitle","text","__dirname","JSON","stringify","error","console","meta","module","require","main","catch"],"mappings":"AAAA,SAASA,MAAM,QAAQ,yBAAyB;AAChD,SAASC,SAAS,QAAQ,iCAAiC;AAC3D,SAASC,gBAAgB,EAAEC,OAAO,QAAQ,2BAA2B;AACrE,SAASC,aAAaC,UAAU,QAAQ,KAAK;AAC7C,SAASC,IAAI,QAAQ,OAAO;AAC5B,SAASC,SAAS,QAAQ,OAAO;AAEjC,SAASC,kBAAkB,QAAQ,sBAAsB;AACzD,OAAOC,cAAc,kBAAkB;AAEvC,MAAML,YAAYG,UAAUF;AAE5B,MAAMK,oBACJC,QAAQC,GAAG,CAACF,iBAAiB,IAAI;AAEnC,MAAMG,SAAS,IAAIb,OAAO;IACxBc,KAAK;QAAC;YAAEC,QAAQ;gBAAC;gBAAS;aAAU;YAAEC,MAAM;QAAQ;KAAE;IACtDC,MAAM,CAAC,EAAEP,kBAAkB,CAAC;AAC9B;AAEA,MAAMQ,iBAAiB,CAACC,MAAQ;IAC9B,MAAM,GAAGC,aAAaC,KAAK,GAAGF,IAAIG,KAAK,CAAC;IACxC,IAAIC,SAASrB,iBAAiBkB;IAC9B,8EAA8E;IAC9E,IAAII,cAAcH;IAClB,IAAIE,WAAWpB,QAAQsB,MAAM,EAAE;QAC7BD,cAAcH,KAAKK,OAAO,CAAC,SAAS;IACtC,CAAC;IACD,+DAA+D;IAC/D,6EAA6E;IAC7E,gEAAgE;IAChE,IAAIH,WAAWpB,QAAQwB,QAAQ,IAAI,CAACN,KAAKO,QAAQ,CAAC,MAAM;QACtDL,SAASpB,QAAQ0B,aAAa;IAChC,CAAC;IACD,OAAO;QACLR,MAAMG;QACND;IACF;AACF;AAEA,MAAMO,wBAAwB,CAC5BX,KACAY,UAAU;IACR;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD,GACE;IACH,MAAM,EAAEV,KAAI,EAAEE,OAAM,EAAE,GAAGL,eAAeC;IACxC,IAAI,CAACI,QAAQ;IACb,OAAO;QACLQ;QACAC,OAAO;YACLC,MAAM;gBACJC,QAAQ;oBAAC;wBAAEC,MAAM;4BAAEd;wBAAK;oBAAE;oBAAG;wBAAEc,MAAM;4BAAEZ;wBAAO;oBAAE;iBAAE;YACpD;QACF;QACAa,MAAM;IACR;AACF;AAEA;;;CAGC,GACD,MAAMC,iBAAiB;IACrB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,MAAMC,kBAAkB3B,QAAQC,GAAG,CAAC0B,eAAe,IAAI;AAEvD,eAAeC,oBAAoBC,KAAK,EAAE;IACxC,MAAMC,QAAQ,CAAC,EAAEH,gBAAgB,CAAC,EAAE9B,mBAAmB,CAAC,EAAEP,UAAU,CAAC;IACrE,MAAMyC,WAAWF,MAAMG,MAAM,CAAC,CAACC,OAAOvB,OAAS;QAC7CuB,MAAMC,IAAI,CAAC;YAAEJ;QAAM;QACnBG,MAAMC,IAAI,CAACf,sBAAsBT,MAAM,EAAE;QACzC,OAAOuB;IACT,GAAG,EAAE;IACL,IAAI;QACF,MAAM,EAAEE,KAAI,EAAE,GAAG,MAAMjC,OAAOkC,OAAO,CAAC;YAAED,MAAMJ;QAAS;QACvD,MAAMM,OAAO,EAAE;QACf,KAAK,MAAMC,OAAOH,KAAKI,SAAS,CAAE;YAChC,IAAID,IAAIE,IAAI,CAACA,IAAI,CAACC,MAAM,KAAK,GAAG;gBAC9B,MAAM,CAACC,KAAK,GAAGJ,IAAIE,IAAI,CAACA,IAAI;gBAC5BH,KAAKH,IAAI,CAACQ,KAAKtB,OAAO;YACxB,CAAC;QACH;QACA,0DAA0D;QAC1DiB,KAAKH,IAAI,CACP;YACEG,MAAM;gBACJ;oBACEM,eAAe,EAAE;oBACjBC,YAAY;oBACZC,YAAY;wBACV;qBACD;oBACDnC,MAAM;oBACNoC,OAAO;oBACPC,UAAU,EAAE;gBACd;aACD;YACDnC,QAAQ;QACV,GACA;YACEoC,QAAQ;YACRC,eAAe,IAAI;YACnBC,YAAY;YACZC,aACE;YACFC,mBAAmB,KAAK;YACxBC,IAAI;YACJC,aAAa,IAAI;YACjBC,WACE;YACFC,iBACE;YACFC,KAAK;YACLC,YACE;YACFhD,MAAM;YACNE,QAAQ;YACR+C,MAAM;YACNb,OACE;YACFtC,KAAK;QACP,GACAV;QAEF,MAAML,UACJE,KAAKiE,WAAW,8BAChBC,KAAKC,SAAS,CAACzB,MAAM,GAAG;IAE5B,EAAE,OAAO0B,OAAO;QACdC,QAAQD,KAAK,CAACA,MAAME,IAAI,IAAIF;IAC9B;AACF;AAEA,IAAIG,WAAWC,QAAQC,IAAI,EAAE;IAC3BxC,oBAAoBF,gBAAgB2C,KAAK,CAAC,CAACN,QAAU;QACnDC,QAAQD,KAAK,CAAC,QAAQA;IACxB;AACF,CAAC"}