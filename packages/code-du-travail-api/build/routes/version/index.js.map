{"version":3,"sources":["../../../src/routes/version/index.js"],"sourcesContent":["import elasticsearchClient from \"../../conf/elasticsearch\";\nimport { API_BASE_URL, CDTN_ADMIN_VERSION } from \"../v1.prefix\";\n\nconst getVersionsBody = require(\"./versions.elastic\");\n\nconst Router = require(\"koa-router\");\nconst { DOCUMENTS } = require(\"@socialgouv/cdtn-elasticsearch\");\nconst memoizee = require(\"memoizee\");\n\nconst ES_INDEX_PREFIX = process.env.ES_INDEX_PREFIX || \"cdtn\";\nconst index = `${ES_INDEX_PREFIX}-${CDTN_ADMIN_VERSION}_${DOCUMENTS}`;\nconst router = new Router({ prefix: API_BASE_URL });\n\nasync function _getVersionsBody() {\n  const body = getVersionsBody();\n\n  const response = await elasticsearchClient.search({ body, index });\n  return response;\n}\nconst getVersions = memoizee(_getVersionsBody, {\n  maxAge: 1000 * 5 * 60,\n  preFetch: true,\n  promise: true,\n});\n\n/**\n * Return the API version\n *\n * @example\n * http://localhost:1337/api/v1/version\n *\n * @returns {string} The current api version.\n */\nrouter.get(\"/version\", async (ctx) => {\n  const version =\n    process.env.VERSION || require(\"../../../package.json\").version;\n\n  const response = await getVersions();\n\n  if (response.body.hits.hits.length == 0) {\n    ctx.throw(500, \"Cannot read package versions in Elastic.\");\n  } else {\n    const { data } = response.body.hits.hits[0]._source;\n    ctx.body = { data, version };\n  }\n});\n\nexport default router;\n"],"names":["elasticsearchClient","API_BASE_URL","CDTN_ADMIN_VERSION","getVersionsBody","require","Router","DOCUMENTS","memoizee","ES_INDEX_PREFIX","process","env","index","router","prefix","_getVersionsBody","body","response","search","getVersions","maxAge","preFetch","promise","get","ctx","version","VERSION","hits","length","throw","data","_source"],"mappings":"AAAA,OAAOA,yBAAyB,2BAA2B;AAC3D,SAASC,YAAY,EAAEC,kBAAkB,QAAQ,eAAe;AAEhE,MAAMC,kBAAkBC,QAAQ;AAEhC,MAAMC,SAASD,QAAQ;AACvB,MAAM,EAAEE,UAAS,EAAE,GAAGF,QAAQ;AAC9B,MAAMG,WAAWH,QAAQ;AAEzB,MAAMI,kBAAkBC,QAAQC,GAAG,CAACF,eAAe,IAAI;AACvD,MAAMG,QAAQ,CAAC,EAAEH,gBAAgB,CAAC,EAAEN,mBAAmB,CAAC,EAAEI,UAAU,CAAC;AACrE,MAAMM,SAAS,IAAIP,OAAO;IAAEQ,QAAQZ;AAAa;AAEjD,eAAea,mBAAmB;IAChC,MAAMC,OAAOZ;IAEb,MAAMa,WAAW,MAAMhB,oBAAoBiB,MAAM,CAAC;QAAEF;QAAMJ;IAAM;IAChE,OAAOK;AACT;AACA,MAAME,cAAcX,SAASO,kBAAkB;IAC7CK,QAAQ,OAAO,IAAI;IACnBC,UAAU,IAAI;IACdC,SAAS,IAAI;AACf;AAEA;;;;;;;CAOC,GACDT,OAAOU,GAAG,CAAC,YAAY,OAAOC,MAAQ;IACpC,MAAMC,UACJf,QAAQC,GAAG,CAACe,OAAO,IAAIrB,QAAQ,yBAAyBoB,OAAO;IAEjE,MAAMR,WAAW,MAAME;IAEvB,IAAIF,SAASD,IAAI,CAACW,IAAI,CAACA,IAAI,CAACC,MAAM,IAAI,GAAG;QACvCJ,IAAIK,KAAK,CAAC,KAAK;IACjB,OAAO;QACL,MAAM,EAAEC,KAAI,EAAE,GAAGb,SAASD,IAAI,CAACW,IAAI,CAACA,IAAI,CAAC,EAAE,CAACI,OAAO;QACnDP,IAAIR,IAAI,GAAG;YAAEc;YAAML;QAAQ;IAC7B,CAAC;AACH;AAEA,eAAeZ,OAAO"}