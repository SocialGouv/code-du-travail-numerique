{"version":3,"sources":["../../../src/routes/conventions/index.js"],"sourcesContent":["import elasticsearchClient from \"../../conf/elasticsearch\";\nimport { API_BASE_URL, CDTN_ADMIN_VERSION } from \"../v1.prefix\";\n\nconst Router = require(\"koa-router\");\nconst { DOCUMENTS } = require(\"@socialgouv/cdtn-elasticsearch\");\n\nconst getAgreementBody = require(\"./getAgreementBySlug.elastic\");\n\nconst ES_INDEX_PREFIX = process.env.ES_INDEX_PREFIX || \"cdtn\";\nconst index = `${ES_INDEX_PREFIX}-${CDTN_ADMIN_VERSION}_${DOCUMENTS}`;\n\nconst router = new Router({ prefix: API_BASE_URL });\n\n/**\n * Return the convention collective data that matches the given idcc and type\n *\n * @example\n * http://localhost:1337/api/v1/conventions/200/base\n *\n * @param {string} :idcc the IDCC number\n * @param {string} :type the type of texte requested (either none or \"base\", \"attache\", \"salaire\")\n * @returns {Object} some convention data.\n */\nrouter.get(\"/conventions/:slug\", async (ctx) => {\n  const { slug } = ctx.params;\n  const body = getAgreementBody({ slug });\n  const response = await elasticsearchClient.search({ body, index });\n  if (response.body.hits.total.value === 0) {\n    ctx.throw(404, `agreement not found, no agreement match ${slug}`);\n  }\n\n  ctx.body = { ...response.body.hits.hits[0]._source };\n});\n\nexport default router;\n"],"names":["elasticsearchClient","API_BASE_URL","CDTN_ADMIN_VERSION","Router","require","DOCUMENTS","getAgreementBody","ES_INDEX_PREFIX","process","env","index","router","prefix","get","ctx","slug","params","body","response","search","hits","total","value","throw","_source"],"mappings":"AAAA,OAAOA,yBAAyB,2BAA2B;AAC3D,SAASC,YAAY,EAAEC,kBAAkB,QAAQ,eAAe;AAEhE,MAAMC,SAASC,QAAQ;AACvB,MAAM,EAAEC,UAAS,EAAE,GAAGD,QAAQ;AAE9B,MAAME,mBAAmBF,QAAQ;AAEjC,MAAMG,kBAAkBC,QAAQC,GAAG,CAACF,eAAe,IAAI;AACvD,MAAMG,QAAQ,CAAC,EAAEH,gBAAgB,CAAC,EAAEL,mBAAmB,CAAC,EAAEG,UAAU,CAAC;AAErE,MAAMM,SAAS,IAAIR,OAAO;IAAES,QAAQX;AAAa;AAEjD;;;;;;;;;CASC,GACDU,OAAOE,GAAG,CAAC,sBAAsB,OAAOC,MAAQ;IAC9C,MAAM,EAAEC,KAAI,EAAE,GAAGD,IAAIE,MAAM;IAC3B,MAAMC,OAAOX,iBAAiB;QAAES;IAAK;IACrC,MAAMG,WAAW,MAAMlB,oBAAoBmB,MAAM,CAAC;QAAEF;QAAMP;IAAM;IAChE,IAAIQ,SAASD,IAAI,CAACG,IAAI,CAACC,KAAK,CAACC,KAAK,KAAK,GAAG;QACxCR,IAAIS,KAAK,CAAC,KAAK,CAAC,wCAAwC,EAAER,KAAK,CAAC;IAClE,CAAC;IAEDD,IAAIG,IAAI,GAAG;QAAE,GAAGC,SAASD,IAAI,CAACG,IAAI,CAACA,IAAI,CAAC,EAAE,CAACI,OAAO;IAAC;AACrD;AAEA,eAAeb,OAAO"}