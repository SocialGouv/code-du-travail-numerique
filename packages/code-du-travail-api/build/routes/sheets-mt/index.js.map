{"version":3,"sources":["../../../src/routes/sheets-mt/index.js"],"sourcesContent":["import elasticsearchClient from \"../../conf/elasticsearch\";\nimport { API_BASE_URL, CDTN_ADMIN_VERSION } from \"../v1.prefix\";\n\nconst Router = require(\"koa-router\");\nconst { DOCUMENTS } = require(\"@socialgouv/cdtn-elasticsearch\");\nconst { getRelatedItems } = require(\"../items/getRelatedItems\");\nconst { getSheetMTQuery } = require(\"./search.elastic.js\");\n\nconst ES_INDEX_PREFIX = process.env.ES_INDEX_PREFIX || \"cdtn\";\nconst index = `${ES_INDEX_PREFIX}-${CDTN_ADMIN_VERSION}_${DOCUMENTS}`;\n\nconst router = new Router({ prefix: API_BASE_URL });\n\n/**\n * Return the sheet-mt that match a given slug\n *\n * @example\n * http://localhost:1337/api/v1/sheets-mt/:slug\n *\n * @returns {Object} An object containing the matching sheet-mt .\n */\n\nrouter.get(\"/sheets-mt/:slug\", async (ctx) => {\n  const { slug } = ctx.params;\n  const body = getSheetMTQuery({ slug });\n  const response = await elasticsearchClient.search({\n    body,\n    index,\n  });\n  if (response.body.hits.hits.length === 0) {\n    ctx.throw(404, `there is no sheet mt that match ${slug}`);\n  }\n\n  const sheetMT = response.body.hits.hits[0];\n\n  const relatedItems = await getRelatedItems({\n    covisits: sheetMT._source.covisits,\n    settings: sheetMT._source.title,\n    slug,\n    title: sheetMT._source.title,\n  });\n\n  delete sheetMT._source.covisits;\n\n  ctx.body = {\n    ...sheetMT,\n    relatedItems,\n  };\n});\n\nexport default router;\n"],"names":["elasticsearchClient","API_BASE_URL","CDTN_ADMIN_VERSION","Router","require","DOCUMENTS","getRelatedItems","getSheetMTQuery","ES_INDEX_PREFIX","process","env","index","router","prefix","get","ctx","slug","params","body","response","search","hits","length","throw","sheetMT","relatedItems","covisits","_source","settings","title"],"mappings":"AAAA,OAAOA,yBAAyB,2BAA2B;AAC3D,SAASC,YAAY,EAAEC,kBAAkB,QAAQ,eAAe;AAEhE,MAAMC,SAASC,QAAQ;AACvB,MAAM,EAAEC,UAAS,EAAE,GAAGD,QAAQ;AAC9B,MAAM,EAAEE,gBAAe,EAAE,GAAGF,QAAQ;AACpC,MAAM,EAAEG,gBAAe,EAAE,GAAGH,QAAQ;AAEpC,MAAMI,kBAAkBC,QAAQC,GAAG,CAACF,eAAe,IAAI;AACvD,MAAMG,QAAQ,CAAC,EAAEH,gBAAgB,CAAC,EAAEN,mBAAmB,CAAC,EAAEG,UAAU,CAAC;AAErE,MAAMO,SAAS,IAAIT,OAAO;IAAEU,QAAQZ;AAAa;AAEjD;;;;;;;CAOC,GAEDW,OAAOE,GAAG,CAAC,oBAAoB,OAAOC,MAAQ;IAC5C,MAAM,EAAEC,KAAI,EAAE,GAAGD,IAAIE,MAAM;IAC3B,MAAMC,OAAOX,gBAAgB;QAAES;IAAK;IACpC,MAAMG,WAAW,MAAMnB,oBAAoBoB,MAAM,CAAC;QAChDF;QACAP;IACF;IACA,IAAIQ,SAASD,IAAI,CAACG,IAAI,CAACA,IAAI,CAACC,MAAM,KAAK,GAAG;QACxCP,IAAIQ,KAAK,CAAC,KAAK,CAAC,gCAAgC,EAAEP,KAAK,CAAC;IAC1D,CAAC;IAED,MAAMQ,UAAUL,SAASD,IAAI,CAACG,IAAI,CAACA,IAAI,CAAC,EAAE;IAE1C,MAAMI,eAAe,MAAMnB,gBAAgB;QACzCoB,UAAUF,QAAQG,OAAO,CAACD,QAAQ;QAClCE,UAAUJ,QAAQG,OAAO,CAACE,KAAK;QAC/Bb;QACAa,OAAOL,QAAQG,OAAO,CAACE,KAAK;IAC9B;IAEA,OAAOL,QAAQG,OAAO,CAACD,QAAQ;IAE/BX,IAAIG,IAAI,GAAG;QACT,GAAGM,OAAO;QACVC;IACF;AACF;AAEA,eAAeb,OAAO"}