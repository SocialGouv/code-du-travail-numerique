{"version":3,"sources":["../../../src/routes/items/index.js"],"sourcesContent":["import elasticsearchClient from \"../../conf/elasticsearch\";\nimport { API_BASE_URL, CDTN_ADMIN_VERSION } from \"../v1.prefix\";\n\nconst Router = require(\"koa-router\");\nconst { DOCUMENTS } = require(\"@socialgouv/cdtn-elasticsearch\");\nconst getItemBySlugBody = require(\"./searchBySourceSlug.elastic\");\nconst getDocumentByUrlBody = require(\"./searchByUrl.elastic\");\nconst { getRelatedItems } = require(\"./getRelatedItems\");\n\nconst ES_INDEX_PREFIX = process.env.ES_INDEX_PREFIX || \"cdtn\";\nconst index = `${ES_INDEX_PREFIX}-${CDTN_ADMIN_VERSION}_${DOCUMENTS}`;\n\nconst router = new Router({ prefix: API_BASE_URL });\n\n/**\n * Return document matching the given source+slug.\n *\n * @example\n * http://localhost:1337/api/v1/items/:source/:slug\n *\n * @param {string} :source The item source.\n * @param {string} :slug The item slug to fetch.\n * @returns {Object} Result.\n */\nrouter.get(\"/items/:source/:slug\", async (ctx) => {\n  const { source, slug } = ctx.params;\n  const body = getItemBySlugBody({ slug, source }, true);\n  const response = await elasticsearchClient.search({ body, index });\n\n  if (response.body.hits.total.value === 0) {\n    ctx.throw(404, `there is no documents that match ${slug} in ${source}`);\n  }\n\n  const item = response.body.hits.hits[0];\n\n  const {\n    _id,\n    _source: { title, covisits },\n  } = item;\n\n  const relatedItems = await getRelatedItems({\n    covisits,\n    settings: [{ _id }],\n    slug,\n    title,\n  });\n\n  delete item._source.title_vector;\n  delete item._source.covisits;\n\n  ctx.body = {\n    ...item,\n    relatedItems,\n  };\n});\n\n/**\n * Return document matching the given id.\n *\n * @example\n * http://localhost:1337/api/v1/items/:id\n *\n * @param {string} :id The item id.\n * @returns {Object} Result.\n */\nrouter.get(\"/items/:id\", async (ctx) => {\n  const { id } = ctx.params;\n\n  const response = await elasticsearchClient.get({\n    id,\n    index: index,\n    type: \"_doc\",\n  });\n  delete response.body._source.title_vector;\n  ctx.body = { ...response.body };\n});\n\n/**\n * Return document matching the given url.\n *\n * @example\n * http://localhost:1337/api/v1/items?url=:url\n *\n * @param {string} :url The item url.\n * @returns {Object} Result.\n */\nrouter.get(\"/items\", async (ctx) => {\n  const { url } = ctx.query;\n  const body = getDocumentByUrlBody({ url });\n  const response = await elasticsearchClient.search({ body, index });\n\n  if (response.body.hits.total.value === 0) {\n    ctx.throw(404, `there is no document that match ${url}`);\n  }\n\n  const [item] = response.body.hits.hits;\n  delete item.title_vector;\n  ctx.body = { ...item };\n});\n\nexport default router;\n"],"names":["elasticsearchClient","API_BASE_URL","CDTN_ADMIN_VERSION","Router","require","DOCUMENTS","getItemBySlugBody","getDocumentByUrlBody","getRelatedItems","ES_INDEX_PREFIX","process","env","index","router","prefix","get","ctx","source","slug","params","body","response","search","hits","total","value","throw","item","_id","_source","title","covisits","relatedItems","settings","title_vector","id","type","url","query"],"mappings":"AAAA,OAAOA,yBAAyB,2BAA2B;AAC3D,SAASC,YAAY,EAAEC,kBAAkB,QAAQ,eAAe;AAEhE,MAAMC,SAASC,QAAQ;AACvB,MAAM,EAAEC,UAAS,EAAE,GAAGD,QAAQ;AAC9B,MAAME,oBAAoBF,QAAQ;AAClC,MAAMG,uBAAuBH,QAAQ;AACrC,MAAM,EAAEI,gBAAe,EAAE,GAAGJ,QAAQ;AAEpC,MAAMK,kBAAkBC,QAAQC,GAAG,CAACF,eAAe,IAAI;AACvD,MAAMG,QAAQ,CAAC,EAAEH,gBAAgB,CAAC,EAAEP,mBAAmB,CAAC,EAAEG,UAAU,CAAC;AAErE,MAAMQ,SAAS,IAAIV,OAAO;IAAEW,QAAQb;AAAa;AAEjD;;;;;;;;;CASC,GACDY,OAAOE,GAAG,CAAC,wBAAwB,OAAOC,MAAQ;IAChD,MAAM,EAAEC,OAAM,EAAEC,KAAI,EAAE,GAAGF,IAAIG,MAAM;IACnC,MAAMC,OAAOd,kBAAkB;QAAEY;QAAMD;IAAO,GAAG,IAAI;IACrD,MAAMI,WAAW,MAAMrB,oBAAoBsB,MAAM,CAAC;QAAEF;QAAMR;IAAM;IAEhE,IAAIS,SAASD,IAAI,CAACG,IAAI,CAACC,KAAK,CAACC,KAAK,KAAK,GAAG;QACxCT,IAAIU,KAAK,CAAC,KAAK,CAAC,iCAAiC,EAAER,KAAK,IAAI,EAAED,OAAO,CAAC;IACxE,CAAC;IAED,MAAMU,OAAON,SAASD,IAAI,CAACG,IAAI,CAACA,IAAI,CAAC,EAAE;IAEvC,MAAM,EACJK,IAAG,EACHC,SAAS,EAAEC,MAAK,EAAEC,SAAQ,EAAE,CAAA,EAC7B,GAAGJ;IAEJ,MAAMK,eAAe,MAAMxB,gBAAgB;QACzCuB;QACAE,UAAU;YAAC;gBAAEL;YAAI;SAAE;QACnBV;QACAY;IACF;IAEA,OAAOH,KAAKE,OAAO,CAACK,YAAY;IAChC,OAAOP,KAAKE,OAAO,CAACE,QAAQ;IAE5Bf,IAAII,IAAI,GAAG;QACT,GAAGO,IAAI;QACPK;IACF;AACF;AAEA;;;;;;;;CAQC,GACDnB,OAAOE,GAAG,CAAC,cAAc,OAAOC,MAAQ;IACtC,MAAM,EAAEmB,GAAE,EAAE,GAAGnB,IAAIG,MAAM;IAEzB,MAAME,WAAW,MAAMrB,oBAAoBe,GAAG,CAAC;QAC7CoB;QACAvB,OAAOA;QACPwB,MAAM;IACR;IACA,OAAOf,SAASD,IAAI,CAACS,OAAO,CAACK,YAAY;IACzClB,IAAII,IAAI,GAAG;QAAE,GAAGC,SAASD,IAAI;IAAC;AAChC;AAEA;;;;;;;;CAQC,GACDP,OAAOE,GAAG,CAAC,UAAU,OAAOC,MAAQ;IAClC,MAAM,EAAEqB,IAAG,EAAE,GAAGrB,IAAIsB,KAAK;IACzB,MAAMlB,OAAOb,qBAAqB;QAAE8B;IAAI;IACxC,MAAMhB,WAAW,MAAMrB,oBAAoBsB,MAAM,CAAC;QAAEF;QAAMR;IAAM;IAEhE,IAAIS,SAASD,IAAI,CAACG,IAAI,CAACC,KAAK,CAACC,KAAK,KAAK,GAAG;QACxCT,IAAIU,KAAK,CAAC,KAAK,CAAC,gCAAgC,EAAEW,IAAI,CAAC;IACzD,CAAC;IAED,MAAM,CAACV,KAAK,GAAGN,SAASD,IAAI,CAACG,IAAI,CAACA,IAAI;IACtC,OAAOI,KAAKO,YAAY;IACxBlB,IAAII,IAAI,GAAG;QAAE,GAAGO,IAAI;IAAC;AACvB;AAEA,eAAed,OAAO"}