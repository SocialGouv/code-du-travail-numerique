{"version":3,"sources":["../../../src/routes/stats/index.ts"],"sourcesContent":["import type { Context } from \"koa\";\nimport type { Response } from \"node-fetch\";\nimport fetch from \"node-fetch\";\n\nimport elasticsearchClient from \"../../conf/elasticsearch\";\nimport { API_BASE_URL, CDTN_ADMIN_VERSION } from \"../v1.prefix\";\n\nconst Router = require(\"koa-router\");\n\nconst { DOCUMENTS } = require(\"@socialgouv/cdtn-elasticsearch\");\nconst docsCountBody = require(\"../docs-count/docCount.elastic\");\n\nconst router = new Router({ prefix: API_BASE_URL });\n\nconst ES_INDEX_PREFIX = process.env.ES_INDEX_PREFIX ?? \"cdtn\";\nconst index = `${ES_INDEX_PREFIX}-${CDTN_ADMIN_VERSION}_${DOCUMENTS}`;\n\nconst MATOMO_SITE_ID = process.env.PIWIK_SITE_ID ?? \"3\";\nconst MATOMO_URL =\n  process.env.PIWIK_URL ?? \"https://matomo.fabrique.social.gouv.fr\";\n\nrouter.get(\"/stats\", async (ctx: Context) => {\n  if (!MATOMO_SITE_ID && !MATOMO_URL) {\n    ctx.throw(500, `There is no matomo`);\n    return;\n  }\n\n  const {\n    body: { aggregations },\n  } = await elasticsearchClient.search({ body: docsCountBody, index });\n  let nbDocuments = 0;\n  const { buckets = [] } = aggregations.sources;\n  for (const { doc_count } of buckets) {\n    nbDocuments += doc_count;\n  }\n\n  const URLS = [\n    `${MATOMO_URL}/?module=API&method=VisitsSummary.getVisits&idSite=${MATOMO_SITE_ID}&format=JSON&period=range&date=2020-01-01,today`,\n    `${MATOMO_URL}/?module=API&method=Actions.get&idSite=${MATOMO_SITE_ID}&format=JSON&period=range&date=2020-01-01,today`,\n  ];\n  const promises: Promise<any>[] = URLS.map(async (url) =>\n    fetch(url)\n      .then(async (data: Response) => data.json())\n      .catch((e: Error) => {\n        console.error(e);\n        return null;\n      })\n  );\n  const [nbVisitData, infoData] = await Promise.all(promises);\n\n  if (!nbVisitData && !infoData) {\n    ctx.status = 502;\n    ctx.body = {};\n  } else {\n    ctx.body = {\n      nbDocuments,\n      nbPageViews: infoData.nb_pageviews,\n      nbSearches: infoData.nb_searches,\n      nbVisits: nbVisitData.value,\n    };\n  }\n});\n\nexport default router;\n"],"names":["fetch","elasticsearchClient","API_BASE_URL","CDTN_ADMIN_VERSION","Router","require","DOCUMENTS","docsCountBody","router","prefix","ES_INDEX_PREFIX","process","env","index","MATOMO_SITE_ID","PIWIK_SITE_ID","MATOMO_URL","PIWIK_URL","get","ctx","throw","body","aggregations","search","nbDocuments","buckets","sources","doc_count","URLS","promises","map","url","then","data","json","catch","e","console","error","nbVisitData","infoData","Promise","all","status","nbPageViews","nb_pageviews","nbSearches","nb_searches","nbVisits","value"],"mappings":"AAEA,OAAOA,WAAW,aAAa;AAE/B,OAAOC,yBAAyB,2BAA2B;AAC3D,SAASC,YAAY,EAAEC,kBAAkB,QAAQ,eAAe;AAEhE,MAAMC,SAASC,QAAQ;AAEvB,MAAM,EAAEC,UAAS,EAAE,GAAGD,QAAQ;AAC9B,MAAME,gBAAgBF,QAAQ;AAE9B,MAAMG,SAAS,IAAIJ,OAAO;IAAEK,QAAQP;AAAa;AAEjD,MAAMQ,kBAAkBC,QAAQC,GAAG,CAACF,eAAe,IAAI;AACvD,MAAMG,QAAQ,CAAC,EAAEH,gBAAgB,CAAC,EAAEP,mBAAmB,CAAC,EAAEG,UAAU,CAAC;AAErE,MAAMQ,iBAAiBH,QAAQC,GAAG,CAACG,aAAa,IAAI;AACpD,MAAMC,aACJL,QAAQC,GAAG,CAACK,SAAS,IAAI;AAE3BT,OAAOU,GAAG,CAAC,UAAU,OAAOC,MAAiB;IAC3C,IAAI,CAACL,kBAAkB,CAACE,YAAY;QAClCG,IAAIC,KAAK,CAAC,KAAK,CAAC,kBAAkB,CAAC;QACnC;IACF,CAAC;IAED,MAAM,EACJC,MAAM,EAAEC,aAAY,EAAE,CAAA,EACvB,GAAG,MAAMrB,oBAAoBsB,MAAM,CAAC;QAAEF,MAAMd;QAAeM;IAAM;IAClE,IAAIW,cAAc;IAClB,MAAM,EAAEC,SAAU,EAAE,CAAA,EAAE,GAAGH,aAAaI,OAAO;IAC7C,KAAK,MAAM,EAAEC,UAAS,EAAE,IAAIF,QAAS;QACnCD,eAAeG;IACjB;IAEA,MAAMC,OAAO;QACX,CAAC,EAAEZ,WAAW,mDAAmD,EAAEF,eAAe,+CAA+C,CAAC;QAClI,CAAC,EAAEE,WAAW,uCAAuC,EAAEF,eAAe,+CAA+C,CAAC;KACvH;IACD,MAAMe,WAA2BD,KAAKE,GAAG,CAAC,OAAOC,MAC/C/B,MAAM+B,KACHC,IAAI,CAAC,OAAOC,OAAmBA,KAAKC,IAAI,IACxCC,KAAK,CAAC,CAACC,IAAa;YACnBC,QAAQC,KAAK,CAACF;YACd,OAAO,IAAI;QACb;IAEJ,MAAM,CAACG,aAAaC,SAAS,GAAG,MAAMC,QAAQC,GAAG,CAACb;IAElD,IAAI,CAACU,eAAe,CAACC,UAAU;QAC7BrB,IAAIwB,MAAM,GAAG;QACbxB,IAAIE,IAAI,GAAG,CAAC;IACd,OAAO;QACLF,IAAIE,IAAI,GAAG;YACTG;YACAoB,aAAaJ,SAASK,YAAY;YAClCC,YAAYN,SAASO,WAAW;YAChCC,UAAUT,YAAYU,KAAK;QAC7B;IACF,CAAC;AACH;AAEA,eAAezC,OAAO"}