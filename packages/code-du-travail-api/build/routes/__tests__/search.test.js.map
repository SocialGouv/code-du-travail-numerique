{"version":3,"sources":["../../../src/routes/__tests__/search.test.js"],"sourcesContent":["import router from \"../search\";\n\nconst request = require(\"supertest\");\nconst Koa = require(\"koa\");\nconst { SOURCES } = require(\"@socialgouv/cdtn-sources\");\n\nconst getSearchBody = require(\"../search/search.elastic\");\nconst getSemBody = require(\"../search/search.sem\");\n\nrequire(\"./__mocking__/mockNLP\");\n\njest.mock(\"@socialgouv/cdtn-elasticsearch\");\n\nconst app = new Koa();\napp.use(router.routes());\n\nit(\"asks same sources wether it is search sem or search elastic and gets a description\", () => {\n  const searchBody = getSearchBody({ sources: [SOURCES.CDT] });\n  const semBody = getSemBody({ sources: [SOURCES.CDT] });\n  expect(searchBody._source).toEqual(semBody._source);\n  expect(searchBody._source).toContain(\"description\");\n});\n\nit(\"returns search results for demission from prequalified requests\", async () => {\n  const response = await request(app.callback()).get(\n    \"/api/v1/search?q=démission\"\n  );\n  expect(response.status).toBe(200);\n  expect(response.body).toMatchSnapshot(); // prequalified results completed by ES results\n});\n\nit(\"returns 3 search results for demission from elastic if size = 3\", async () => {\n  const response = await request(app.callback()).get(\n    \"/api/v1/search?q=démission&skipSavedResults&size=3\"\n  );\n  expect(response.status).toBe(200);\n  expect(response.body.documents.length).toBe(3);\n});\n\nit(\"returns search results for demission from elastic\", async () => {\n  const response = await request(app.callback()).get(\n    \"/api/v1/search?q=démission&skipSavedResults\"\n  );\n  expect(response.status).toBe(200);\n  expect(response.body).toMatchSnapshot();\n});\n\nit(\"returns article results when searching article R1225-18\", async () => {\n  const response = await request(app.callback()).get(\n    `/api/v1/search?q=r1225-18`\n  );\n  expect(response.status).toBe(200);\n  expect(response.body).toMatchSnapshot();\n});\nit(\"returns unique documents from prequalified data (same slug but different source)\", async () => {\n  const response = await request(app.callback()).get(\n    `/api/v1/search?q=certificat de travail`\n  );\n  expect(response.status).toBe(200);\n  expect(response.body).toMatchSnapshot();\n});\n\nit(\"return conventions\", async () => {\n  const response = await request(app.callback()).get(\n    `/api/v1/search?q=boulangerie`\n  );\n  expect(response.status).toBe(200);\n  expect(response.body).toMatchSnapshot();\n});\n"],"names":["router","request","require","Koa","SOURCES","getSearchBody","getSemBody","jest","mock","app","use","routes","it","searchBody","sources","CDT","semBody","expect","_source","toEqual","toContain","response","callback","get","status","toBe","body","toMatchSnapshot","documents","length"],"mappings":"AAAA,OAAOA,YAAY,YAAY;AAE/B,MAAMC,UAAUC,QAAQ;AACxB,MAAMC,MAAMD,QAAQ;AACpB,MAAM,EAAEE,QAAO,EAAE,GAAGF,QAAQ;AAE5B,MAAMG,gBAAgBH,QAAQ;AAC9B,MAAMI,aAAaJ,QAAQ;AAE3BA,QAAQ;AAERK,KAAKC,IAAI,CAAC;AAEV,MAAMC,MAAM,IAAIN;AAChBM,IAAIC,GAAG,CAACV,OAAOW,MAAM;AAErBC,GAAG,sFAAsF,IAAM;IAC7F,MAAMC,aAAaR,cAAc;QAAES,SAAS;YAACV,QAAQW,GAAG;SAAC;IAAC;IAC1D,MAAMC,UAAUV,WAAW;QAAEQ,SAAS;YAACV,QAAQW,GAAG;SAAC;IAAC;IACpDE,OAAOJ,WAAWK,OAAO,EAAEC,OAAO,CAACH,QAAQE,OAAO;IAClDD,OAAOJ,WAAWK,OAAO,EAAEE,SAAS,CAAC;AACvC;AAEAR,GAAG,mEAAmE,UAAY;IAChF,MAAMS,WAAW,MAAMpB,QAAQQ,IAAIa,QAAQ,IAAIC,GAAG,CAChD;IAEFN,OAAOI,SAASG,MAAM,EAAEC,IAAI,CAAC;IAC7BR,OAAOI,SAASK,IAAI,EAAEC,eAAe,IAAI,+CAA+C;AAC1F;AAEAf,GAAG,mEAAmE,UAAY;IAChF,MAAMS,WAAW,MAAMpB,QAAQQ,IAAIa,QAAQ,IAAIC,GAAG,CAChD;IAEFN,OAAOI,SAASG,MAAM,EAAEC,IAAI,CAAC;IAC7BR,OAAOI,SAASK,IAAI,CAACE,SAAS,CAACC,MAAM,EAAEJ,IAAI,CAAC;AAC9C;AAEAb,GAAG,qDAAqD,UAAY;IAClE,MAAMS,WAAW,MAAMpB,QAAQQ,IAAIa,QAAQ,IAAIC,GAAG,CAChD;IAEFN,OAAOI,SAASG,MAAM,EAAEC,IAAI,CAAC;IAC7BR,OAAOI,SAASK,IAAI,EAAEC,eAAe;AACvC;AAEAf,GAAG,2DAA2D,UAAY;IACxE,MAAMS,WAAW,MAAMpB,QAAQQ,IAAIa,QAAQ,IAAIC,GAAG,CAChD,CAAC,yBAAyB,CAAC;IAE7BN,OAAOI,SAASG,MAAM,EAAEC,IAAI,CAAC;IAC7BR,OAAOI,SAASK,IAAI,EAAEC,eAAe;AACvC;AACAf,GAAG,oFAAoF,UAAY;IACjG,MAAMS,WAAW,MAAMpB,QAAQQ,IAAIa,QAAQ,IAAIC,GAAG,CAChD,CAAC,sCAAsC,CAAC;IAE1CN,OAAOI,SAASG,MAAM,EAAEC,IAAI,CAAC;IAC7BR,OAAOI,SAASK,IAAI,EAAEC,eAAe;AACvC;AAEAf,GAAG,sBAAsB,UAAY;IACnC,MAAMS,WAAW,MAAMpB,QAAQQ,IAAIa,QAAQ,IAAIC,GAAG,CAChD,CAAC,4BAA4B,CAAC;IAEhCN,OAAOI,SAASG,MAAM,EAAEC,IAAI,CAAC;IAC7BR,OAAOI,SAASK,IAAI,EAAEC,eAAe;AACvC"}