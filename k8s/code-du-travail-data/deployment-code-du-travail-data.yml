---
apiVersion: v1
kind: Pod
metadata:
  name: cdtn-data${BRANCH_NAME}
  labels:
    app: cdtn-data${BRANCH_NAME}
spec:
  containers:
  - name: cdtn-data${BRANCH_NAME}
    image: registry.gitlab.factory.social.gouv.fr/socialgouv/code-du-travail-numerique/data:${IMAGE_TAG}
    env:
    - name: ELASTICSEARCH_URL
      value: http://elasticsearch${BRANCH_NAME}:${ES_PORT}
  restartPolicy: Never
  initContainers:
  - name: wait-for-elasticsearch
    image: alpine
    imagePullPolicy: Always
    args:
    - ash
    - -c
    - |
      apk --no-cache add curl
      ENDPOINT="http://elasticsearch${BRANCH_NAME}:${ES_PORT}"
      echo Checking: ${ENDPOINT}
      while [[ $(curl --silent --output /dev/null --request GET --write-out "%{http_code}" ${ENDPOINT}) -ne 200 ]]; do
        echo "Not ready"
        sleep 5s
      done
      echo Ready
